# Script to help debug and trial issues relating to the cibuildwheel
# repair-wheel command, and our use of remove_source.py to make
# binary only wheels.

name: ExplictWheelRepair

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      # Name to connect to an artifact generated by buildAndSave (dummy or real)
      saveName:
        required: true
        type: string
      # some unresolved issues have been noted on mac and windows
      targetOS:
        required: true
        type: string
      # The command to look at the contents of the directory will vary by
      # targetOS
      check:
        required: false
        default: ""
        type: string


jobs:
  wheelRepair:
    runs-on: ${{inputs.targetOS}}
    steps:
      - uses: actions/checkout@v3
        with:
          sparse-checkout: |
            remove_source.py

      - name: first directory check
        run: ${{inputs.check}}

      - uses: actions/download-artifact@v3
        with:
          name: ${{inputs.saveName}}
        
      - name: second directory check
        run: ${{inputs.check}}
      
      - name: get package
        run: pip install wheel
      
      - name: remove source script
        run: python remove_source.py . *.whl
      
      - name: third directory check
        run: ${{inputs.check}}
      
      - uses: actions/upload-artifact@v3
        with:
          name: ${{inputs.saveName}}
          path: ./*.whl
          retention-days: 1
